<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Ninja Stealth Demo - Lights</title>
  <style>
    body { margin: 0; background: black; }
    canvas { display: block; margin: auto; touch-action: none; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/phaser@3.70.0/dist/phaser.js"></script>
</head>
<body>

<script>
class NinjaScene extends Phaser.Scene {
    constructor() {
        super({ key: 'NinjaScene' });
    }

    preload() {
        this.load.image('bg', 'https://i.ibb.co/Fs1zT5Q/castle-bg.png');
        this.load.image('ground', 'https://i.ibb.co/SmcZs3p/ground-tile.png');
        this.load.spritesheet('ninja', 'https://i.ibb.co/5n7pWmH/ninja-sprite.png', { frameWidth: 32, frameHeight: 32 });
        this.load.spritesheet('knight', 'https://i.ibb.co/sJ2LmFq/knight-sprite.png', { frameWidth: 32, frameHeight: 32 });
        this.load.image('torch', 'https://i.ibb.co/BLjYwDW/torch.png');
    }

    create() {
        this.lights.enable().setAmbientColor(0x111111);

        this.add.image(400, 300, 'bg').setPipeline('Light2D').setScale(1.3);

        const platforms = this.physics.add.staticGroup();
        for (let x = 0; x < 800; x += 64) {
            platforms.create(x, 568, 'ground').setOrigin(0).refreshBody().setPipeline('Light2D');
        }

        this.torch = this.physics.add.staticSprite(400, 500, 'torch').setPipeline('Light2D');
        this.torchLight = this.lights.addLight(400, 500, 200).setColor(0xffaa00).setIntensity(2);

        this.player = this.physics.add.sprite(100, 450, 'ninja').setScale(2).setPipeline('Light2D');
        this.player.setCollideWorldBounds(true);
        this.physics.add.collider(this.player, platforms);

        this.knight = this.physics.add.sprite(600, 450, 'knight').setScale(2).setPipeline('Light2D');
        this.knight.setCollideWorldBounds(true);
        this.physics.add.collider(this.knight, platforms);
        this.knightDirection = -1;

        this.anims.create({ key: 'ninja_walk', frames: this.anims.generateFrameNumbers('ninja', { start: 0, end: 3 }), frameRate: 10, repeat: -1 });
        this.anims.create({ key: 'ninja_idle', frames: [{ key: 'ninja', frame: 0 }], frameRate: 10 });
        this.anims.create({ key: 'knight_walk', frames: this.anims.generateFrameNumbers('knight', { start: 0, end: 3 }), frameRate: 8, repeat: -1 });

        this.cursors = this.input.keyboard.createCursorKeys();
        this.attackKey = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.SPACE);
        this.physics.add.overlap(this.player, this.knight, this.onOverlap, null, this);

        this.alertBar = this.add.rectangle(400, 20, 0, 20, 0xff0000).setOrigin(0.5).setScrollFactor(0);
        this.alertLevel = 0;

        this.createTouchControls();
    }

    createTouchControls() {
        this.input.addPointer(1);
        this.leftZone = this.add.zone(0, 300, 200, 600).setOrigin(0).setInteractive();
        this.rightZone = this.add.zone(200, 300, 200, 600).setOrigin(0).setInteractive();
        this.jumpZone = this.add.zone(600, 300, 200, 600).setOrigin(0).setInteractive();
        this.attackZone = this.add.zone(400, 300, 200, 600).setOrigin(0).setInteractive();

        this.leftPressed = false; this.rightPressed = false; this.jumpPressed = false; this.attackPressed = false;

        this.leftZone.on('pointerdown', () => this.leftPressed = true).on('pointerup', () => this.leftPressed = false);
        this.rightZone.on('pointerdown', () => this.rightPressed = true).on('pointerup', () => this.rightPressed = false);
        this.jumpZone.on('pointerdown', () => this.jumpPressed = true).on('pointerup', () => this.jumpPressed = false);
        this.attackZone.on('pointerdown', () => this.attackPressed = true).on('pointerup', () => this.attackPressed = false);
    }

    onOverlap(player, knight) {
        if (this.attackKey.isDown || this.attackPressed) {
            knight.destroy();
            this.alertLevel = 0;
        } else {
            this.alertLevel = 100;
        }
    }

    update() {
        // Player control
        if (this.cursors.left.isDown || this.leftPressed) {
            this.player.setVelocityX(-160);
            this.player.anims.play('ninja_walk', true);
        } else if (this.cursors.right.isDown || this.rightPressed) {
            this.player.setVelocityX(160);
            this.player.anims.play('ninja_walk', true);
        } else {
            this.player.setVelocityX(0);
            this.player.anims.play('ninja_idle', true);
        }

        if ((this.cursors.up.isDown || this.jumpPressed) && this.player.body.touching.down) {
            this.player.setVelocityY(-330);
        }

        // Knight patrol
        this.knight.setVelocityX(50 * this.knightDirection);
        this.knight.anims.play('knight_walk', true);
        if (this.knight.x < 500) this.knightDirection = 1;
        if (this.knight.x > 700) this.knightDirection = -1;

        // Lights follow
        this.torchLight.x = this.torch.x;
        this.torchLight.y = this.torch.y;

        // Stealth detection
        let inLight = Phaser.Math.Distance.Between(this.player.x, this.player.y, this.torch.x, this.torch.y) < 200;
        if (inLight && Phaser.Math.Distance.Between(this.player.x, this.player.y, this.knight.x, this.knight.y) < 150) {
            this.alertLevel = Math.min(100, this.alertLevel + 1);
        } else {
            this.alertLevel = Math.max(0, this.alertLevel - 1);
        }
        this.alertBar.width = this.alertLevel * 4;
    }
}

const config = {
    type: Phaser.WEBGL,
    width: 800,
    height: 600,
    backgroundColor: '#000',
    physics: { default: 'arcade', arcade: { gravity: { y: 500 }, debug: false } },
    scene: [NinjaScene],
    pipeline: { light2d: Phaser.Renderer.WebGL.Pipelines.Light2DPipeline },
    dom: { createContainer: true }
};

new Phaser.Game(config);
</script>

</body>
</html>
